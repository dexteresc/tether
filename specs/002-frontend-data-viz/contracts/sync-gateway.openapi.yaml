openapi: 3.1.0
info:
  title: Tether Sync Gateway (Proposed)
  version: "0.1.0"
  description: |
    Proposed contract that abstracts “pull changes / push outbox tx” for the local‑first frontend.
    The initial implementation may call Supabase PostgREST + Realtime directly from the browser,
    but this contract documents the expected semantics for a dedicated gateway (Go API or Supabase Edge Functions).
servers:
  - url: http://localhost:8080
paths:
  /api/sync/snapshot:
    get:
      summary: Fetch a paginated snapshot for one table
      security:
        - bearerAuth: []
      parameters:
        - in: query
          name: table
          required: true
          schema:
            $ref: "#/components/schemas/TableName"
        - in: query
          name: limit
          required: false
          schema: { type: integer, minimum: 1, maximum: 500, default: 200 }
        - in: query
          name: page_token
          required: false
          schema: { type: ["string", "null"] }
      responses:
        "200":
          description: Snapshot page
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SnapshotPage"
  /api/sync/changes:
    get:
      summary: Fetch changes since a cursor
      description: |
        Returns inserted/updated rows plus tombstones (deleted_at != null) since `since_updated_at`.
        Cursor is per-table and based on server `updated_at` (see triggers in `/Users/dexteresc/Dev/tether/supabase/migrations/20251210231648_create_triggers.sql`).
      security:
        - bearerAuth: []
      parameters:
        - in: query
          name: table
          required: true
          schema:
            $ref: "#/components/schemas/TableName"
        - in: query
          name: since_updated_at
          required: true
          schema:
            type: string
            format: date-time
        - in: query
          name: limit
          required: false
          schema: { type: integer, minimum: 1, maximum: 500, default: 200 }
      responses:
        "200":
          description: Change batch
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ChangeBatch"
  /api/sync/transactions:
    post:
      summary: Push a batch of outbox transactions (ordered)
      description: |
        Applies transactions in order. For updates, the server MUST enforce optimistic concurrency:
        updates/deletes are conditional on `base_updated_at` matching the current row’s `updated_at`.
        Conflicts return `conflicts[]` and keep the server version as the winner.
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/PushTransactionsRequest"
      responses:
        "200":
          description: Per-tx results, applied rows, and conflicts
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PushTransactionsResponse"
components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
  schemas:
    TableName:
      type: string
      enum: [sources, entities, identifiers, relations, intel, intel_entities]
    SnapshotPage:
      type: object
      properties:
        table: { $ref: "#/components/schemas/TableName" }
        rows:
          type: array
          items: { type: object, additionalProperties: true }
        next_page_token: { type: ["string", "null"] }
        server_time:
          type: string
          format: date-time
      required: [table, rows, next_page_token, server_time]
    ChangeBatch:
      type: object
      properties:
        table: { $ref: "#/components/schemas/TableName" }
        since_updated_at:
          type: string
          format: date-time
        rows:
          type: array
          description: Full rows including tombstones (deleted_at set)
          items: { type: object, additionalProperties: true }
        next_cursor_updated_at:
          type: string
          format: date-time
        server_time:
          type: string
          format: date-time
      required: [table, since_updated_at, rows, next_cursor_updated_at, server_time]
    OutboxTransaction:
      type: object
      properties:
        tx_id: { type: string, format: uuid }
        created_at: { type: string, format: date-time }
        table: { $ref: "#/components/schemas/TableName" }
        op:
          type: string
          enum: [insert, update, delete]
        record_id: { type: string, format: uuid }
        payload:
          type: object
          additionalProperties: true
        base_updated_at:
          type: ["string", "null"]
          format: date-time
      required: [tx_id, created_at, table, op, record_id, payload]
    PushTransactionsRequest:
      type: object
      properties:
        transactions:
          type: array
          minItems: 1
          items: { $ref: "#/components/schemas/OutboxTransaction" }
      required: [transactions]
    TxResult:
      type: object
      properties:
        tx_id: { type: string, format: uuid }
        status:
          type: string
          enum: [applied, conflict, rejected]
        error: { type: ["string", "null"] }
        applied_row:
          anyOf:
            - type: object
              additionalProperties: true
            - type: "null"
      required: [tx_id, status, error, applied_row]
    Conflict:
      type: object
      properties:
        tx_id: { type: string, format: uuid }
        table: { $ref: "#/components/schemas/TableName" }
        record_id: { type: string, format: uuid }
        server_row: { type: object, additionalProperties: true }
        local_row: { type: object, additionalProperties: true }
        reason:
          type: string
          enum: [update_precondition_failed, deleted_on_server, other]
      required: [tx_id, table, record_id, server_row, local_row, reason]
    PushTransactionsResponse:
      type: object
      properties:
        results:
          type: array
          items: { $ref: "#/components/schemas/TxResult" }
        conflicts:
          type: array
          items: { $ref: "#/components/schemas/Conflict" }
        server_time:
          type: string
          format: date-time
      required: [results, conflicts, server_time]

