openapi: 3.1.0
info:
  title: Tether LLM Service (Extraction)
  version: "1.0.0"
  description: |
    HTTP contract for the existing FastAPI service in `/Users/dexteresc/Dev/tether/llm-service/`.
    The frontend uses this service with `sync_to_db=false` to support review/accept/edit before DB sync.
servers:
  - url: http://localhost:8000
paths:
  /api/health:
    get:
      summary: Service health
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  status: { type: string }
                  provider: { type: string }
                  model: { type: string }
                required: [status, provider, model]
  /api/extract:
    post:
      summary: Extract structured intelligence from natural language
      description: |
        Matches `/Users/dexteresc/Dev/tether/llm-service/app/routes/extract.py`.
        Frontend calls this endpoint with `sync_to_db=false` and then stages results locally.
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ExtractionRequest"
      responses:
        "200":
          description: Extraction result (with classification and optional sync_results)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ClassifiedExtractionResponse"
        "401":
          description: Unauthorized (only required when sync_to_db=true)
components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
  schemas:
    ExtractionRequest:
      type: object
      properties:
        text:
          type: string
        context:
          type: ["string", "null"]
        source_code:
          type: ["string", "null"]
          default: "LLM"
        sync_to_db:
          type: boolean
          default: false
      required: [text]
    ClassifiedExtractionResponse:
      type: object
      properties:
        classification:
          type: string
          enum: [fact_update, event_log, mixed]
        chain_of_thought:
          type: string
        extraction:
          $ref: "#/components/schemas/IntelligenceExtraction"
        sync_results:
          anyOf:
            - $ref: "#/components/schemas/SyncResults"
            - type: "null"
      required: [classification, chain_of_thought, extraction]
    IntelligenceExtraction:
      type: object
      properties:
        reasoning:
          $ref: "#/components/schemas/Reasoning"
        entities:
          type: array
          items: { $ref: "#/components/schemas/EntityExtraction" }
        relations:
          type: array
          items: { $ref: "#/components/schemas/RelationExtraction" }
        intel:
          type: array
          items: { $ref: "#/components/schemas/IntelExtraction" }
      required: [reasoning, entities, relations, intel]
    Reasoning:
      type: object
      properties:
        entities_identified: { type: string }
        relationships_identified: { type: string }
        facts_identified: { type: string }
        events_identified: { type: string }
        sources_identified: { type: string }
        confidence_rationale: { type: string }
      required:
        - entities_identified
        - relationships_identified
        - facts_identified
        - events_identified
        - sources_identified
        - confidence_rationale
    ConfidenceLevel:
      type: string
      enum: [confirmed, high, medium, low, unconfirmed]
    EntityType:
      type: string
      enum: [person, organization, group, vehicle, location, event]
    IdentifierType:
      type: string
      enum: [name, document, biometric, phone, email, handle, address, registration, domain]
    RelationType:
      type: string
      enum:
        - parent
        - child
        - sibling
        - spouse
        - colleague
        - associate
        - friend
        - member
        - owner
        - founder
        - co-founder
        - visited
        - employee
    IntelType:
      type: string
      enum: [event, communication, sighting, report, document, media, financial]
    IdentifierExtraction:
      type: object
      properties:
        identifier_type: { $ref: "#/components/schemas/IdentifierType" }
        value: { type: string }
        metadata:
          type: ["object", "null"]
          additionalProperties: true
      required: [identifier_type, value]
    EntityExtraction:
      type: object
      properties:
        name: { type: string }
        entity_type: { $ref: "#/components/schemas/EntityType" }
        identifiers:
          type: array
          items: { $ref: "#/components/schemas/IdentifierExtraction" }
        attributes:
          type: object
          additionalProperties: true
        confidence: { $ref: "#/components/schemas/ConfidenceLevel" }
        source_reference: { type: ["string", "null"] }
      required: [name, entity_type, identifiers, attributes, confidence]
    RelationExtraction:
      type: object
      properties:
        source_entity_name: { type: string }
        target_entity_name: { type: string }
        relation_type: { $ref: "#/components/schemas/RelationType" }
        strength:
          type: ["integer", "null"]
          minimum: 1
          maximum: 10
        valid_from: { type: ["string", "null"] }
        valid_to: { type: ["string", "null"] }
        description: { type: ["string", "null"] }
        confidence: { $ref: "#/components/schemas/ConfidenceLevel" }
        source_reference: { type: ["string", "null"] }
      required: [source_entity_name, target_entity_name, relation_type, confidence]
    IntelExtraction:
      type: object
      properties:
        intel_type: { $ref: "#/components/schemas/IntelType" }
        description: { type: string }
        occurred_at: { type: ["string", "null"] }
        entities_involved:
          type: array
          items: { type: string }
        location: { type: ["string", "null"] }
        details:
          type: object
          additionalProperties: true
        confidence: { $ref: "#/components/schemas/ConfidenceLevel" }
        source_reference: { type: ["string", "null"] }
      required: [intel_type, description, entities_involved, details, confidence]
    SyncResults:
      type: object
      properties:
        entities_created:
          type: array
          items: { type: object, additionalProperties: true }
        entities_updated:
          type: array
          items: { type: object, additionalProperties: true }
        relations_created:
          type: array
          items: { type: object, additionalProperties: true }
        intel_created:
          type: array
          items: { type: object, additionalProperties: true }
      additionalProperties: true

